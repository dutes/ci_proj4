{% extends 'base.html' %}

{% block content %}
<h1>Edit Recipes</h1>

<ul>
    {% for recipe in recipes %}
    <li>
        <span>{{ recipe.name }}</span>
        <button class="edit-button" data-recipe-id="{{ recipe.id }}">Edit</button>
    </li>
    {% endfor %}
</ul>

<!--modal to actually edit recipes-->
<div id="edit-modal" style="display: none;">
    <form id="edit-form" method="POST">
        {% csrf_token %}
        <label for="name">Name: </label>
        <input type="text" name="name" id="name">

        <label for="ingredients">Ingredients: </label>
        <textarea name="ingredients" id="ingredients"></textarea>

        <label for="instructions">Instructions: </label>
        <textarea name="instructions" id="instructions"></textarea>

        <label for="category">Category: </label>
        <select name="category" id="category">
            <option value="Starters">Starter</option>
            <option value="Mains">Main</option>
            <option value="Desserts">Dessert</option>
        </select>

        <button type="submit">Save</button>
        <button id="cancel-edit" type="button">Cancel</button>
    </form>
</div>

<script>
    const modal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const nameField = document.getElementById('name');
    const ingredientsField = document.getElementById('ingredients');
    const instructionsField = document.getElementById('instructions');
    const categoryField = document.getElementById('category');
    const cancelEdit = document.getElementById('cancel-edit');

    document.querySelectorAll('.edit-button').forEach(button => {
        button.addEventListener('click', () => {
            const recipeId = button.getAttribute('data-recipe-id');

            fetch(`/edit_recipe/details/${recipeId}/`)
                .then(response => response.json())
                .then(data => {
                    nameField.value = data.name;
                    ingredientsField.value = data.ingredients;
                    instructionsField.value = data.instructions;
                    categoryField.value = data.category;
                    editForm.action = `/edit_recipe/update/${recipeId}`;

                    modal.style.display = 'block';
                })
                .catch(error => alert('An error occured getting recipe details'));
        });
    });

    editForm.addEventListener('submit', (event) => {
        event.preventDefault();
    
        const formData = new FormData(editForm);

        fetch(editForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Recipe updated successfully');
                window.location.reload();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => alert('There was an error with the fectch request: ' + error.message));
    });

    cancelEdit.addEventListener('click', () => {
        modal.style.display = 'none';
    });
</script>
{% endblock %}