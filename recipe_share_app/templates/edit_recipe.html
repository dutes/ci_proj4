{% extends 'base.html' %}

{% block content %}
<h1>Edit Recipes</h1>

<ul>
    {% for recipe in recipes %}
    <li>
        <img src="{{ recipe.image.url }}" alt="{{ recipe.name }}" style="width: 100px; height: 100px;">
        <span>{{ recipe.name }}</span>
        <button class="edit-button" data-recipe-id="{{ recipe.id }}">Edit</button>
    </li>
    {% endfor %}
</ul>

<!--semi transparent underlay for edit mode-->
<div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100px; height: 100px; background-color: rgba(0, 0, 0, 0.5);"></div>

<!--modal to actually edit recipes-->
<div id="edit-modal" style="display: none;">
    <form id="edit-form" method="POST">
        {% csrf_token %}

        <!--show current image in list-->
        <label for="image">Current image: </label>
        <img id="current-image" src="" alt="current recipe image" style="width: 100px; height: 100px;">

        <!--allow user to upload a new image-->
        <label for="image">Current image: </label>
        <input type="file" name="image" id="image">

        <label for="name">Name: </label>
        <input type="text" name="name" id="name">

        <label for="ingredients">Ingredients: </label>
        <textarea name="ingredients" id="ingredients"></textarea>

        <label for="instructions">Instructions: </label>
        <textarea name="instructions" id="instructions"></textarea>

        <label for="category">Category: </label>
        <select name="category" id="category">
            <option value="Starters">Starter</option>
            <option value="Mains">Main</option>
            <option value="Desserts">Dessert</option>
        </select>

        <button type="submit">Save</button>
        <button id="cancel-edit" type="button">Cancel</button>
    </form>
</div>

<script>
    const modal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    const nameField = document.getElementById('name');
    const ingredientsField = document.getElementById('ingredients');
    const instructionsField = document.getElementById('instructions');
    const categoryField = document.getElementById('category');
    const cancelEdit = document.getElementById('cancel-edit');

    document.querySelectorAll('.edit-button').forEach(button => {
        button.addEventListener('click', () => {
            const recipeId = button.getAttribute('data-recipe-id');

            fetch(`/edit_recipe/details/${recipeId}/`)
                .then(response => {
                    console.log('response: ', response.status); //debugging
                    if (!response.ok) {
                        throw new Error('http error: ' + response.status);
                    }
                    response.json()
                .then(data => {
                    console.log('recieved recipe data: ', data); //debugging
                    nameField.value = data.name;
                    ingredientsField.value = data.ingredients;
                    instructionsField.value = data.instructions;
                    categoryField.value = data.category;
                    // update and display the current image
                    if (data.image) {
                        currentImage.src = data.image;
                        currentImage.style.display = 'block';
                    } else {
                        currentImage.src = '';
                        currentImage.style.display = 'none';
                    }

                    editForm.action = `/edit_recipe/update/${recipeId}/`;
                    overlay.style.display = 'block';
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('fetch erro ', error); //debugging
                    alert('An error occured getting recipe details');
                });
            });
        });
    });

    editForm.addEventListener('submit', (event) => {
        event.preventDefault();
    
        const formData = new FormData(editForm);

        fetch(editForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Recipe updated successfully');
                window.location.reload();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => alert('There was an error with the fectch request: ' + error.message));
    });

    cancelEdit.addEventListener('click', () => {
        modal.style.display = 'none';
    });
</script>
{% endblock %}