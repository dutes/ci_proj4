{% extends 'base.html' %}

{% block content %}
<h1>Edit Recipe</h1>

<ul>
    {% for recipe in recipes %}
    <li>
        <input type="checkbox" class="select-recipe" name="recipe_id" value="{{ recipe.id }}">
        {{ recipe.name }}
    </li>
    {% endfor %}
</ul>

<button id="edit-button">Edit selected</button>

<!-- Modal -->
<div id="edit-modal" style="display: none;">
    <form id="edit-form" method="POST" action="">
        {% csrf_token %}
        <label for="name">Name:</label>
        <input type="text" id="name" name="name">

        <label for="ingredients">Ingredients:</label>
        <textarea id="ingredients" name="ingredients"></textarea>

        <label for="instructions">Instructions:</label>
        <textarea id="instructions" name="instructions"></textarea>

        <label for="category">Category:</label>
        <select id="category" name="category">
            <option value="Starters">Starters</option>
            <option value="Mains">Mains</option>
            <option value="Desserts">Desserts</option>
        </select>

        <button type="submit">Save</button>
        <button type="button" id="cancel-edit">Cancel</button>
    </form>
</div>

<div id="overlay" style="display: none; position: fixed; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>

<script>
    console.log('edit recipe script loaded');
    const editButton = document.getElementById('edit-button');
    const modal = document.getElementById('edit-modal');
    const overlay = document.getElementById('overlay');
    const cancelEdit = document.getElementById('cancel-edit');
    const editForm = document.getElementById('edit-form');
    const recipeName = document.getElementById('name');
    const recipeIngredients = document.getElementById('ingredients');
    const recipeInstructions = document.getElementById('instructions');
    const recipeCategory = document.getElementById('category');

    editButton.addEventListener('click', () => {
        const selectedCheckbox = document.querySelector('.select-recipe:checked');
        if (!selectedCheckbox) {
            alert('Please select a recipe to edit');
            return;
        }

        const recipeId = selectedCheckbox.value;

        fetch(`/recipe_details/${recipeId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch recipe details');
                }
                return response.json();
            })
            .then(data => {
                recipeName.value = data.name;
                recipeIngredients.value = data.ingredients;
                recipeInstructions.value = data.instructions;
                recipeCategory.value = data.category;

                editForm.action = `/edit/${recipeId}/`;

                modal.style.display = 'block';
                overlay.style.display = 'block';
            })
            .catch(error => {
                alert('Error fetching recipe details');
                console.error('Error:', error);
            });
    });

    cancelEdit.addEventListener('click', () => {
        modal.style.display = 'none';
        overlay.style.display = 'none';
    });

    editForm.addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(editForm);

        console.log('Submitting form data:', [...formData.entries()]);

        fetch(editForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => {
            if (!response.ok) {
            throw new Error(`HTTP erro! status: ' + ${response.status}`);
            }   
            return response.json();
        })
        .then(data => {
            console.log('Server response:', data);

            if (data.success) {
                alert('Recipe updated successfully!');
                window.location.reload();
            } else {
                alert('Error: ' + JSON.stringify(data.errors));
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('An unexpected error occurred.');
        });
    });
</script>
{% endblock %}
