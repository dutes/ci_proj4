{% extends 'base.html' %}

{% block content %}
<div class="container text-center">
    <h1> Welcome to the Recipe Share App!</h1>
    {% if user.is_authenticated %}
        <h2>Welcome, {{ user.username }}! Please contribute by adding a recipe.</h2>
    {% else %}
        <p>If you don't have an account, please create one to be able to add, view, edit or delete a recipe.</p>

<!-- toast messages -->
        {% if messages %}
        <div aria-live="polite" aria-atomic="true" class="position-relative">
            <div class="toast-container position-absolute top-0 start-0 p-3">
                {% for message in messages %}
                <div class="toast align-items-center test-white bg-success border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">{{ message }}</div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!--- buttons to open login and signup modals -->
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
        <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#signupModal">Sign Up</button>
    {% endif %}
</div>

<!---login modal-->
<div class="modal fade" id="loginModal" tabindex='-1' aria-labelledby="loginModalLabel" aria-hidden='true'
data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content">
            <div class="modal-title" id="loginModalLabel">
                <h5 class="modal-title">Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
             <!--modal body-->   
            <div class='modal-body'>
                <form method="post" action="{% url 'index' %}" class="p-3">
                    {% csrf_token %}
                    <!---username field-->
                    <div class="mb-3">
                        <label for="id_login-username" class="form-label fw-semibold">Username</label>
                        <input type="text" name="login-username" id="id_login-username" class="form-control" 
                        placeholder="Enter your username" autocomplete="username" required>
                    </div>
                    <!---password field-->
                    <div class="mb-3">
                        <label for="id_login-password" class="form-label">Password</label>
                        <input type="password" name="login-password" id="id_login-password" class="form-control" 
                        placeholder="Enter your password" autocomplete="new-password" required>
                    </div>
                   <!---submit button-->
                    <div class="d-grip gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" name="login" class="btn btn-primary w-100">Login</button>
                    <button type="button" class="btn-secondary w-100" data-bs-dismiss="modal">Cancel</button>
                    </div>

                    <!--modal footer-->
                    <div class="modal-footer text-center">
                        <p class="small text-muuted w-100">
                            Don't have an account? <a href="#" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#signupModal">Sign Up</a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!---signup modal-->
<div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true"
data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class=modal"content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="signupModalLabel">Sign Up</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'index' %}" id="signup-form">
                        {% csrf_token %}
                        <!---username field-->
                        <div class="mb-3">
                            <label for="id_signup-username" class="form-label fw-semibold">Username</label>
                            <input type="text" name="signup-username" id="id_signup-username" class="form-control" 
                            placeholder="Enter your username" autocomplete="username" required>
                            <div id="username-feedback" class="invalid-feedback"></div>
                        </div>
                        <!---passwords-->
                        <!---password1 field-->
                        <div class="mb-3">
                            <label for="signup-password1" class="form-label">Password</label>
                            <input type="password" name="signup-password1" id="signup-password1" class="form-control"
                            placeholder="Enter your password" autocomplete="new-password" required>
                        </div>
                        <!---password2 field-->
                        <div class="mb-3">
                            <label for="signup-password2" class="form-label">Confirm Password</label>
                            <input type="password" name="signup-password2" id="signup-password2" class="form-control"
                            placeholder="Confirm your password" autocomplete="new-password" required>
                            <div id="password-feedback" class="form-text text-danger"></div>
                        </div>
                        <div class="text-end">
                            <button type="submit" name="signup" class="btn btn-primary">Sign Up</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const signupForm = document.getElementById("signup-form");
        const signupModal = document.getElementById("signupModal");
        const loginForm = document.querySelector("form[action='{% url 'index' %}']");
        const loginModal = document.getElementById("loginModal");
    
        const usernameField = document.getElementById("id_signup-username");
        const usernameFeedback = document.getElementById("username-feedback");
    
        const password1Field = document.getElementById("signup-password1");
        const passwordConfirmationField = document.getElementById("signup-password2");
        const passwordFeedback = document.getElementById("password-feedback");
    
        function clearForm(form, feedbackElements = []) {
            if (form) form.reset();
            feedbackElements.forEach((element) => {
                if (element) element.textContent = "";
            });
        }
    
        // Clear forms on modal close
        signupModal.addEventListener("hidden.bs.modal", () => {
            console.log("Signup modal closed");
            clearForm(signupForm, [usernameFeedback, passwordFeedback]);
        });
    
        loginModal.addEventListener("hidden.bs.modal", () => {
            console.log("Login modal closed");
            clearForm(loginForm);
        });
    
        usernameField.addEventListener("input", () => {
            const username = usernameField.value.trim();
            const usernameRegex = /^[a-zA-Z0-9_]{5,20}$/;
    
            if (username.length < 5) {
                usernameFeedback.textContent = "Username must be at least 5 characters long.";
            } else if (username.length > 20) {
                usernameFeedback.textContent = "Username must be at most 20 characters long.";
            } else if (!usernameRegex.test(username)) {
                usernameFeedback.textContent = "Username must only contain letters, numbers, and underscores.";
            } else {
                usernameFeedback.textContent = "";
            }
        });
    
        function validatePassword() {
            const password = password1Field.value;
            const confirmPassword = passwordConfirmationField.value;
    
            if (password.length < 8) {
                passwordFeedback.textContent = "Password must be at least 8 characters long.";
            } else if (password !== confirmPassword) {
                passwordFeedback.textContent = "Passwords do not match.";
            } else {
                passwordFeedback.textContent = "";
            }
        }
    
        password1Field.addEventListener("input", validatePassword);
        passwordConfirmationField.addEventListener("input", validatePassword);
    });
    
    

//toast messages
const toastContainer = document.querySelector(".toast-container");
const toastElements = toastContainer.querySelectorAll(".toast");
//if toast is present, auto dismiss after 5 seconds
if (toastElements.length) {
    const toast = new bootstrap.Toast(toastElements[0], { delay: 5000 });
    toast.show();
}
//clear old toast
setTimeout(() => {
    while (toastContainer.firstChild) {
        toastContainer.removeChild(toastContainer.firstChild);
        }
    }, 3500);
});

</script>
{% endblock %}
